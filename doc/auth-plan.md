
## 11. OAuth / 2FA / 電話認証（設計追記）

### OAuth（外部ログイン）
- 実装タイミング: 後段（フェーズC以降）推奨。
- フロー推奨: Authorization Code + PKCE（SPAの場合）またはサーバーサイドでクライアントシークレットを保持して処理。
- 注意点:
  - 外部プロバイダから取得するプロフィール情報の正規化（emailが無いケース等）
  - 既存アカウントとの紐付け（リンク）と重複防止フロー
  - セキュリティ: リダイレクトURI の厳格管理、CSRF対策（state）

### 二段階認証（本プロジェクト方針）
- 方針: TOTP（Google Authenticator 等）のみを当面実装する。SMSは将来検討だが初期は実装しない。
- 実装要点:
  - セットアップ
    - サーバーはユーザーごとに TOTP シークレット（ランダム）を生成し、安全に保存（DBに暗号化するか、少なくともアクセス制御を厳格にする）。
    - QRコード（otpauth:// URI）を生成してフロントに渡し、ユーザーはAuthenticatorアプリで登録する。
    - バックアップコードを発行・保存（ユーザーに表示して控えさせる）。
  - 認証フロー
    - ログイン成功（ID/PW）後、ユーザーに 2FA が有効な場合は一時トークン（短命）で 2FA チャレンジ画面へ遷移。
    - クライアントは POST /api/auth/2fa/verify { userId, code, sessionToken } を呼び、サーバーが TOTP を検証。
    - 検証成功で最終的な access/refresh を発行。
  - API候補
    - GET /api/auth/2fa/setup  — TOTP シークレットと QR を取得（認証済みユーザー向け）
    - POST /api/auth/2fa/confirm — 初回登録時のコード確認
    - POST /api/auth/2fa/verify — ログイン時のコード検証
    - POST /api/auth/2fa/backup/generate — バックアップコード再生成
  - セキュリティ注意点
    - シークレットは平文でログに出力しない。DBに保存する場合は暗号化検討。
    - バックアップコードは一度使用したら無効化。
    - レート制限（2FAコードの検証）を必須にする。

### 電話番号認証（現時点は将来対応）
- 設計指針:
  - 電話番号は E.164 形式で保存し、表示はマスクする。
  - SMSは外部プロバイダ（Twilio等）を使用する前提。
  - 検証コードは短命（例5分）、試行回数制限とレート制限を実施。
- 現状: 計画には記載しておくが初期リリースでは未実装。

## 12. セキュリティ詳細（追記）
- トークン管理
  - access: 短寿命（例: 5〜15分）、署名付きJWT
  - refresh: 長寿命（例: 7〜30日）、サーバー側で失効リスト/デバイス単位で管理（DB or Redis）
  - リフレッシュトークンのローテーション: refresh 使用時に新しい refresh を発行し、古いものを無効化
- 保存場所
  - SPA: access をメモリ、refresh を HttpOnly, Secure, SameSite cookie に保存することを推奨
  - サーバーサイドレンダリング: セッション/Cookie ベースの管理も可
- CSRF と CORS
  - Cookie ベース認証を使う場合は CSRF トークンを導入
  - CORS はフロントドメインのみ許可、必要なヘッダとメソッドを限定
- レート制限・監査
  - ログイン・2FA検証・パスワード変更・SMS送信に対してレート制限を実施
  - 監査ログに認証イベントを残す（個人情報はマスク）
- シークレット管理
  - JWTシークレット、OAuthク���イアントシークレット等は環境変数か Vault で管理
- テスト
  - TOTP のユニットテスト・統合テスト（固定シークレットでの検証）を作成

## 13. 追加タスク（A 実行後の続き）
- auth-plan.md に上記を追記済み。
- 次に行う D の要望を具体的に指示してください。提案例:
  1) サーバー側での TOTP 実装（エンティティ、サービス、コントローラー、QR生成）を作成
  2) フロントの2FA登録/検証画面の雛形を作成
  3) フェーズAの実装（/api/auth/login, /api/signup など）を進める
